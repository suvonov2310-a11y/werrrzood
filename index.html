<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shashka Pro Online</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background: #121212; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; touch-action: manipulation; }
        #board { display: grid; grid-template-columns: repeat(8, 11vw); grid-template-rows: repeat(8, 11vw); border: 5px solid #2ec4b6; margin-top: 10px; }
        .cell { width: 11vw; height: 11vw; display: flex; align-items: center; justify-content: center; }
        .black { background: #4e342e; } .white { background: #d7ccc8; }
        .piece { width: 9vw; height: 9vw; border-radius: 50%; cursor: pointer; }
        .red { background: #c62828; box-shadow: inset 0 0 10px #000; }
        .light { background: #f5f5f5; box-shadow: inset 0 0 10px #999; border: 1px solid #333; }
        .selected { outline: 3px solid #ffeb3b; transform: scale(1.1); }
        #status { margin-top: 20px; padding: 10px; background: #2ec4b6; width: 88vw; text-align: center; border-radius: 5px; font-weight: bold; }
        #login { margin-top: 50px; text-align: center; }
        input { padding: 12px; font-size: 16px; border-radius: 5px; border: none; width: 60vw; margin-bottom: 10px; }
        button { padding: 12px 25px; background: #2ec4b6; border: none; color: white; font-weight: bold; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="login">
        <h2>SHASHKA ONLINE</h2>
        <input type="text" id="rid" placeholder="Xona ID (masalan: 777)"> <br>
        <button onclick="join()">KIRISH</button>
    </div>

    <div id="game" style="display:none;">
        <div id="status">Raqib kutilmoqda...</div>
        <div id="board"></div>
    </div>

    <script>
        const socket = io();
        let myRoom, selected = null, gameActive = false;
        let board = Array(8).fill().map(() => Array(8).fill(null));

        function join() {
            myRoom = document.getElementById('rid').value;
            if(!myRoom) return;
            document.getElementById('login').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            socket.emit('join-room', myRoom);
            initBoard();
        }

        socket.on('status-update', (data) => {
            document.getElementById('status').innerText = data.msg;
            gameActive = data.active;
        });

        function initBoard() {
            for(let r=0; r<8; r++) {
                for(let c=0; c<8; c++) {
                    if((r+c)%2 !== 0) {
                        if(r < 3) board[r][c] = 'light';
                        else if(r > 4) board[r][c] = 'red';
                    }
                }
            }
            render();
        }

        function render() {
            const bDiv = document.getElementById('board');
            bDiv.innerHTML = '';
            for(let r=0; r<8; r++) {
                for(let c=0; c<8; c++) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${(r+c)%2!==0 ? 'black' : 'white'}`;
                    
                    if(board[r][c]) {
                        const p = document.createElement('div');
                        p.className = `piece ${board[r][c]}`;
                        if(selected && selected.r === r && selected.c === c) p.classList.add('selected');
                        p.onpointerdown = () => { if(gameActive) { selected = {r, c, type: board[r][c]}; render(); } };
                        cell.appendChild(p);
                    } else if(selected && (r+c)%2 !== 0) {
                        cell.onpointerdown = () => validateAndMove(r, c);
                    }
                    bDiv.appendChild(cell);
                }
            }
        }

        function validateAndMove(r, c) {
            const rowDiff = Math.abs(r - selected.r);
            const colDiff = Math.abs(c - selected.c);

            // Oddiy yurish qoidasi: Faqat 1 katak diagonalga
            if(rowDiff === 1 && colDiff === 1) {
                executeMove(r, c);
            } 
            // Urish (tosh yeyish) qoidasi: 2 katak diagonalga
            else if(rowDiff === 2 && colDiff === 2) {
                const midR = (r + selected.r) / 2;
                const midC = (c + selected.c) / 2;
                if(board[midR][midC] && board[midR][midC] !== selected.type) {
                    board[midR][midC] = null; // Raqib toshini olib tashlash
                    executeMove(r, c);
                }
            }
        }

        function executeMove(r, c) {
            const moveData = { from: {r: selected.r, c: selected.c}, to: {r, c}, type: selected.type };
            socket.emit('move', { roomId: myRoom, move: moveData });
            
            board[selected.r][selected.c] = null; // Eski joydan o'chirish
            board[r][c] = selected.type; // Yangi joyga qo'yish
            selected = null;
            render();
        }

        socket.on('move-received', (m) => {
            board[m.from.r][m.from.c] = null;
            board[m.to.r][m.to.c] = m.type;
            // Agar urib o'tilgan bo'lsa, o'rtadagi toshni o'chirish
            if(Math.abs(m.from.r - m.to.r) === 2) {
                board[(m.from.r + m.to.r)/2][(m.from.c + m.to.c)/2] = null;
            }
            render();
        });
    </script>
</body>
</html>