<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shashka Online Elite</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    
    <style>
        :root { --purple: #6c5ce7; --pink: #fd79a8; --dark: #1a1a2e; }
        body { background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow-x: hidden; }
        
        /* LOBBY DIZAYNI (Siz yuborgan rasmdagidek) */
        #lobby { padding: 15px; display: block; }
        .header-card { background: linear-gradient(135deg, #6c5ce7, #a29bfe); border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); margin-bottom: 20px; }
        .btn { background: white; color: var(--purple); border: none; padding: 15px; border-radius: 12px; width: 100%; margin: 8px 0; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-pink { background: var(--pink); color: white; }
        .btn:active { transform: scale(0.98); }

        .online-list { background: #fff; color: #333; border-radius: 20px; padding: 20px; min-height: 300px; }
        .player-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; align-items: center; }
        .player-name { font-weight: bold; color: var(--dark); }
        .player-score { font-size: 12px; color: #666; }
        .invite-btn { background: var(--purple); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-size: 12px; cursor: pointer; }

        /* O'YIN DOSKASI DIZAYNI */
        #game-screen { display: none; flex-direction: column; align-items: center; padding-top: 20px; }
        #status-bar { background: var(--purple); width: 90%; padding: 10px; border-radius: 10px; text-align: center; margin-bottom: 15px; font-weight: bold; }
        #board { display: grid; grid-template-columns: repeat(8, 11vw); grid-template-rows: repeat(8, 11vw); border: 5px solid var(--purple); background: #fff; }
        .cell { width: 11vw; height: 11vw; display: flex; align-items: center; justify-content: center; }
        .black { background: #333; }
        .white { background: #f0f0f0; }
        
        .piece { width: 9vw; height: 9vw; border-radius: 50%; cursor: pointer; position: relative; transition: 0.2s; }
        .red { background: #d63031; box-shadow: inset 0 0 10px #000; }
        .light { background: #f1f2f6; box-shadow: inset 0 0 10px #999; }
        .damka { border: 3px solid gold; box-shadow: 0 0 15px gold !important; }
        .damka::after { content: 'üëë'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; }
        .selected { outline: 4px solid #00ff00; transform: scale(1.1); z-index: 10; }
    </style>
</head>
<body>

    <div id="lobby">
        <div class="header-card">
            <h1 style="margin:0 0 15px 0">Shashka Online</h1>
            <button class="btn">üîç O'yin Topish</button>
            <button class="btn">üë• Do'stni taklif qilish</button>
            <button class="btn btn-pink" onclick="startRandomGame()">üé≤ Tasodifiy o'yin</button>
        </div>

        <div class="online-list">
            <h3 style="margin:0 0 15px 0; color:var(--purple)">Online o'yinchilar</h3>
            <div id="player-container">
                <p>O'yinchilar qidirilmoqda...</p>
            </div>
        </div>
    </div>

    <div id="game-screen">
        <div id="status-bar">Navbat: Qizillar</div>
        <div id="board"></div>
        <button class="btn btn-pink" style="width:50%; margin-top:20px;" onclick="location.reload()">Chiqish</button>
    </div>

    <script>
        // 1. FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyD_AaQCbi4ipNXkzqRwq9BxQirC1rp-yC0",
            authDomain: "shashka-online.firebaseapp.com",
            projectId: "shashka-online",
            storageBucket: "shashka-online.firebasestorage.app",
            messagingSenderId: "1097808487424",
            appId: "1:1097808487424:web:02d79c42b15a09c93724e5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const socket = io();

        // 2. O'YIN O'ZGARUVCHILARI
        let myId = "id_" + Math.random().toString(16).slice(2);
        let myName = "Buxorolik_" + Math.floor(Math.random() * 9000 + 1000);
        let board = [];
        let selected = null;
        let turn = 'red';
        let myColor = 'red';

        // 3. ONLINE RO'YXATNI BOSHQARISH
        socket.emit('join-lobby', { id: myId, name: myName, points: 1000 });

        socket.on('update-users', (users) => {
            const container = document.getElementById('player-container');
            container.innerHTML = '';
            users.forEach(user => {
                if(user.id !== myId) {
                    container.innerHTML += `
                        <div class="player-row">
                            <div class="player-info">
                                <div class="player-name">${user.name}</div>
                                <div class="player-score">Ball: ${user.points}</div>
                            </div>
                            <button class="invite-btn" onclick="sendInvite('${user.id}')">O'yinga taklif</button>
                        </div>
                    `;
                }
            });
        });

        // 4. O'YIN MANTIQI
        function startRandomGame() {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            initBoard();
        }

        function initBoard() {
            board = Array(8).fill().map(() => Array(8).fill(null));
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    if ((r + c) % 2 !== 0) {
                        if (r < 3) board[r][c] = { color: 'light', isDamka: false };
                        else if (r > 4) board[r][c] = { color: 'red', isDamka: false };
                    }
                }
            }
            render();
        }

        function render() {
            const bDiv = document.getElementById('board');
            bDiv.innerHTML = '';
            document.getElementById('status-bar').innerText = turn === 'red' ? "Navbat: Qizillar" : "Navbat: Oqlar";
            
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${(r + c) % 2 !== 0 ? 'black' : 'white'}`;
                    
                    const p = board[r][c];
                    if (p) {
                        const pDiv = document.createElement('div');
                        pDiv.className = `piece ${p.color} ${p.isDamka ? 'damka' : ''} ${selected?.r===r && selected?.c===c ? 'selected' : ''}`;
                        pDiv.onclick = () => {
                            if (turn === p.color) { selected = { r, c }; render(); }
                        };
                        cell.appendChild(pDiv);
                    } else if (selected) {
                        cell.onclick = () => move(r, c);
                    }
                    bDiv.appendChild(cell);
                }
            }
        }

        function move(toR, toC) {
            if (!selected) return;
            const fromR = selected.r, fromC = selected.c;
            const piece = board[fromR][fromC];

            // Oddiy yurish yoki urish mantiqi (Soddalashtirilgan versiya)
            const rDiff = toR - fromR;
            const cDiff = Math.abs(toC - fromC);

            // Yurishni tekshirish
            if (Math.abs(rDiff) === 1 && cDiff === 1 && !board[toR][toC]) {
                board[toR][toC] = piece;
                board[fromR][fromC] = null;
                finalizeMove(toR, toC);
            } 
            // Urishni tekshirish
            else if (Math.abs(rDiff) === 2 && cDiff === 2) {
                const midR = (fromR + toR) / 2;
                const midC = (fromC + toC) / 2;
                if (board[midR][midC] && board[midR][midC].color !== piece.color) {
                    board[toR][toC] = piece;
                    board[fromR][fromC] = null;
                    board[midR][midC] = null;
                    finalizeMove(toR, toC);
                }
            }
        }

        function finalizeMove(r, c) {
            // Damka tekshiruvi
            if (board[r][c].color === 'red' && r === 0) board[r][c].isDamka = true;
            if (board[r][c].color === 'light' && r === 7) board[r][c].isDamka = true;

            selected = null;
            turn = turn === 'red' ? 'light' : 'red';
            render();
            // Socket orqali serverga yuborish (Sinxronizatsiya uchun)
            socket.emit('move', { r, c, color: turn });
        }
    </script>
</body>
</html>